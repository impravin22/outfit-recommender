FROM node:20-alpine

WORKDIR /app

# System libs (OpenSSL for Prisma) & compatibility
RUN apk add --no-cache libc6-compat openssl openssl-dev

# Copy only dependency manifests & Prisma schema first for optimal layer caching
COPY package.json package-lock.json* ./
COPY prisma ./prisma

# Install all deps (include dev for prisma generate), generate client (retain dev deps until after build)
RUN npm ci --no-audit --maxsockets 1 \
    && npx prisma generate

# Copy application source (exclude heavy artifacts via .dockerignore)
COPY src ./src
COPY public ./public
COPY next.config.js tsconfig.json postcss.config.mjs eslint.config.mjs ./

# Environment configuration
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV DATABASE_URL="file:./dev.db"
ENV NODE_OPTIONS="--max-old-space-size=1024"

# Build Next.js app (needs TypeScript dev dependency)
RUN npm run build

# Remove dev dependencies post-build to slim runtime image
RUN npm prune --production

# Create non-root user for runtime
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs && \
    chown -R nextjs:nodejs /app

USER nextjs

EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Start server
CMD ["npm", "start"]
